<template>
  <v-tooltip bottom transition="none" :disabled="!options.includes('hover')">
    <template v-slot:activator="{ on }">
      <v-card v-on="on" :class="options.includes('mx-auto') && 'mx-auto'" v-if="task" :width="size" :height="size" :flat="options.includes('transparent')" :color="!options.includes('transparent') ? 'grey' : 'transparent'" @click.stop @mouseenter="hovering = true" @mouseleave="hovering = false">
        <v-fade-transition hide-on-leave leave-absolute>
          <v-img v-if="task.thumbnail" contain :src="task.thumbnail" style="position: absolute" />
          <svg v-else :width="size || 100" class="mx-auto" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path
              v-if="!isTaskBox && !isAudition"
              d="m 35.589844,9.5800781 c -0.573351,0.018314 -1.09936,0.2964182 -1.47461,0.6855469 L 19.728516,25.017578 13.339844,18.648437 C 12.507606,17.820892 11.137271,17.809745 10.292969,18.625 l -3.9433596,3.802734 h -0.00195 c -0.8651932,0.836135 -0.8773048,2.249903 -0.027344,3.101563 v 0.002 L 18.208984,37.416016 c 0.844091,0.843029 2.243864,0.839554 3.083985,-0.0078 l 20.013672,-20.148437 0.002,-0.002 c 0.846531,-0.853423 0.831086,-2.267619 -0.03516,-3.101562 l -4.105468,-3.955078 -0.01563,-0.01563 c -0.432247,-0.3815986 -0.98915,-0.6237833 -1.5625,-0.6054689 z m 0.06445,1.9980469 c -0.0039,1.25e-4 0.03782,-0.01158 0.171875,0.105469 0.0018,0.0016 1.32e-4,3.45e-4 0.002,0.002 l 4.058594,3.912109 c 0.0798,0.07683 0.08021,0.171302 0.002,0.25 v 0.002 L 19.873047,36 c -0.07744,0.07811 -0.172347,0.07971 -0.25,0.002 V 36 L 7.7363281,24.117187 c -0.077774,-0.07793 -0.076039,-0.173169 0.00195,-0.25 l 3.9433598,-3.802734 c 0.0771,-0.07444 0.172045,-0.07362 0.248047,0.002 l 7.818359,7.796875 15.804687,-16.207031 0.002,-0.002 c 0.08804,-0.0913 0.103575,-0.0763 0.09961,-0.07617 z"
              fill="#1070ff"
            />
            <path
              v-else-if="!isAudition"
              d="m 21.454744,3.5828806 c -3.388512,0.020648 -7.180933,1.1428628 -9.560387,2.9916171 L 5.8900701,11.239299 c -1.353807,1.051862 -2.0227686,2.163343 -2.0450875,3.170943 l -0.028064,-0.03353 0.017924,22.531078 h 0.01481 c 0.051109,1.292273 1.1832952,2.397213 3.3338936,2.954193 L 23.379756,44.05664 c 3.889349,1.007297 9.575098,-0.166401 12.747704,-2.631406 l 6.003513,-4.664804 c 1.336503,-1.038416 1.955865,-2.13121 2.001428,-3.124162 l 0.0156,-7.74e-4 0.03508,-22.460128 -0.0054,0.0063 C 44.177101,9.8505477 43.03812,8.7077146 40.837524,8.1377851 L 24.641314,3.9431282 C 23.668977,3.6913041 22.584282,3.576034 21.454778,3.5829173 Z M 21.640477,5.55286 c 0.881148,-0.00535 1.72707,0.084231 2.485608,0.280683 l 5.868296,1.5161893 -13.91,10.7510777 -6.8307416,-1.782339 C 7.7561209,15.930631 6.890686,15.202106 6.6931847,14.333415 6.8401002,13.649554 7.350863,12.922022 8.2447385,12.227511 L 14.181317,7.8864302 c 1.856259,-1.442247 4.815718,-2.3174606 7.45916,-2.3335702 z m 9.365143,2.0588434 7.805645,2.2060601 c 1.49195,0.3863975 2.35794,1.1105085 2.559676,1.9749195 -0.143911,0.686899 -0.62491,1.454782 -1.550775,2.116041 l -5.907769,4.219363 c -2.612659,1.731361 -6.910614,2.838698 -9.944768,2.052888 l -6.872008,-1.818194 z m 10.545713,8.1531766 0.06203,17.224694 c -0.120663,0.834939 -0.474675,1.555448 -1.569488,2.406081 l -5.89401,4.282681 c -2.475011,1.922998 -7.036989,2.785578 -10.068823,1.99086 L 9.0960934,37.741273 C 7.6214911,37.358386 6.7587125,36.647266 6.5442135,35.795982 6.5332755,35.481773 6.5223775,35.167563 6.5114795,34.853354 l 0.062027,-16.726227 c 0.0016,-0.399866 0.7736586,0.308211 1.2303287,0.426483 l 15.5759408,3.94655 c 3.889348,1.007296 9.575098,-0.166401 12.747704,-2.631406 z m -12.155588,8.398329 c -1.02595,0 -1.85173,0.825782 -1.85173,1.85173 v 12.760178 c 0,1.02595 0.82578,1.852511 1.85173,1.852511 1.025949,0 1.85173,-0.826561 1.85173,-1.852511 V 26.014939 c 0,-1.025948 -0.825781,-1.85173 -1.85173,-1.85173 z m -8.340974,3.007211 c -0.08912,2.18e-4 -0.177472,0.03172 -0.246378,0.092 l -0.0015,-0.03977 -5.422647,3.846922 -1.812746,-2.43181 c -0.115953,-0.155094 -0.3404,-0.191874 -0.504457,-0.08264 l -1.404197,0.933272 c -0.168288,0.11217 -0.208794,0.334735 -0.09044,0.494315 l 3.03138,4.078486 c 0.11748,0.158308 0.346956,0.194247 0.511468,0.07953 l 7.1699,-4.990706 c 0.165966,-0.11536 0.202683,-0.338638 0.08109,-0.495874 l -1.051003,-1.359755 -0.01248,0.01325 c -0.02295,-0.03978 -0.05353,-0.0753 -0.09044,-0.103698 -0.0502,-0.02301 -0.104023,-0.03366 -0.157495,-0.03353 z"
              fill="#1070ff"
            />
            <path v-else d="m 35.89829,9.207423 v 5.35e-4 c -0.588346,0.01878 -1.127841,0.303851 -1.512912,0.703164 l -6.806261,6.979136 c 2.629844,2.700937 4.652205,4.777455 7.119665,7.311628 l 7.066106,-7.113299 0.0021,-0.0021 c 0.86868,-0.875759 0.852858,-2.327027 -0.03604,-3.182797 L 37.517796,9.844865 37.501906,9.828955 C 37.058344,9.43737 36.486662,9.188663 35.898304,9.207457 Z m -24.390633,8.661745 c -0.5666,-0.0045 -1.13486,0.201613 -1.56806,0.619908 l -4.04664,3.902399 h -0.002 c -0.88784,0.858018 -0.90032,2.308846 -0.0281,3.182796 v 0.0021 l 12.199848,12.195587 c 0.866182,0.865086 2.302656,0.861579 3.164765,-0.0074 l 5.416902,-5.452956 C 22.053485,27.499089 17.12943,22.563427 13.066257,18.51347 c -0.42701,-0.424603 -0.99192,-0.639866 -1.55852,-0.644302 z" fill="#1070ff" />
          </svg>
        </v-fade-transition>
        <RULE :rule="rules.EDIT" v-if="options.includes('edit')">
          <v-tooltip bottom transition="none">
            <template v-slot:activator="{ on }">
              <v-fade-transition>
                <v-btn v-show="hovering" left bottom class="mb-6 mr-10" absolute v-on="on" fab x-small @click.stop="selectImage()">
                  <svg width="30" height="30" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="m 5.3408124,5.7314895 c -1.226767,0 -2.2148737,0.98759 -2.2148737,2.214357 0.030197,6.1083365 0,12.0852235 0,18.2357595 0,2.38137 1.9176336,4.298488 4.2990047,4.298488 H 27.093703 c 2.381372,0 4.298487,-1.917118 4.298487,-4.298488 V 14.19824 c 0,-2.381372 -1.917115,-4.2984882 -4.298487,-4.2984882 H 15.500498 V 7.9458465 c 0,-1.226767 -0.987589,-2.214357 -2.214356,-2.214357 z" transform="translate(7 5)" fill="#252525" style="pointer-events: none" />
                  </svg>
                </v-btn>
              </v-fade-transition>
            </template>
            Select From File
          </v-tooltip>
          <v-tooltip bottom transition="none">
            <template v-slot:activator="{ on }">
              <v-fade-transition>
                <v-btn v-if="task.thumbnail" v-show="hovering" bottom left class="mb-6 ml-11" absolute v-on="on" fab x-small @click.stop="deleteImage()">
                  <svg width="28" height="28" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="m 22.697259,6.2148445 c -1.70345,0 -3.113282,1.4117847 -3.113282,3.1152344 v 1.2187501 h -7.261718 c -0.734301,0 -1.324219,0.591871 -1.324219,1.326172 v 3.921875 c 0,0.7343 0.589918,1.324218 1.324219,1.324218 h 0.578125 c -6.69e-4,0.02955 -0.0039,0.05818 -0.0039,0.08789 v 20.761719 c 0,2.113675 1.700778,3.814453 3.814454,3.814453 h 14.578124 c 2.113676,0 3.814454,-1.700778 3.814454,-3.814453 V 17.208986 c 0,-0.02972 -0.0032,-0.05834 -0.0039,-0.08789 h 0.578125 c 0.734301,0 1.324219,-0.589918 1.324219,-1.324219 v -3.921876 c 0,-0.734301 -0.589918,-1.326172 -1.324219,-1.326172 H 28.416023 V 9.3300789 C 28.416009,7.6266292 27.006177,6.2148445 25.302727,6.2148445 Z m 0,2.5 h 2.605468 c 0.361694,0 0.613282,0.2535403 0.613282,0.6152344 V 10.548829 H 22.083977 V 9.3300789 c 0,-0.3616941 0.251588,-0.6152344 0.613282,-0.6152344 z" fill="#ff5555" style="pointer-events: none" />
                  </svg>
                </v-btn>
              </v-fade-transition>
            </template>
            Delete
          </v-tooltip>
          <v-tooltip bottom transition="none">
            <template v-slot:activator="{ on }">
              <v-fade-transition>
                <v-btn v-show="hovering" bottom right class="mb-6" absolute v-on="on" fab x-small @click.stop="getClipBoardImage()">
                  <svg width="30" height="30" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="m 7.498845,0.9668512 c -2.9328851,0 -5.3356666,2.4027814 -5.3356666,5.3356667 V 21.598217 c 0,2.932886 2.4027815,5.335667 5.3356666,5.335667 h 7.777863 c 2.932885,0 5.335667,-2.402781 5.335667,-5.335667 V 6.3025179 c 0,-2.9328853 -2.402782,-5.3356667 -5.335667,-5.3356667 z m 0,2.6340482 h 7.777863 c 1.519677,0 2.702223,1.1819406 2.702223,2.7016185 V 21.598217 c 0,1.519679 -1.182546,2.702222 -2.702223,2.702222 H 7.498845 c -1.519678,0 -2.7016186,-1.182543 -2.7016188,-2.702222 V 6.3025179 c 0,-1.5196779 1.1819408,-2.7016185 2.7016188,-2.7016185 z m 15.74115,3.3322161 v 2.6334453 h 3.128159 c 1.519678,0 2.702222,1.1825432 2.702222,2.7022222 v 15.298112 c 0,1.519678 -1.182544,2.701619 -2.702222,2.701619 h -7.777863 c -0.970423,0 -1.802813,-0.482301 -2.278095,-1.22653 h -2.844603 c 0.644313,2.221247 2.701253,3.858168 5.122698,3.858165 h 7.777863 c 2.932886,0 5.335668,-2.400369 5.335668,-5.333254 V 12.268783 c 0,-2.9328868 -2.402782,-5.3356675 -5.335668,-5.3356675 z"
                      transform="translate(7 5)"
                      fill="#252525"
                      style="pointer-events: none"
                    />
                  </svg>
                </v-btn>
              </v-fade-transition>
            </template>
            Paste From ClipBoard
          </v-tooltip>
        </RULE>
      </v-card>
    </template>
    {{task.title}}
  </v-tooltip>
</template>

<script>
import RULE from '../navigation/Rule.vue';
import RULES from '../../enums/rules';
const { clipboard, ipcRenderer, nativeImage } = require('electron');
import _ from 'lodash';

export default {
  components: { RULE },
  props: { task: Object, options: Array, size: Number, readOnly: Boolean },
  name: 'Thumbnail',
  data() {
    return {
      hovering: false,
    };
  },
  computed: {
    rules() {
      return RULES;
    },
    isTaskBox() {
      return this.task.taskType == 'taskbox' ? true : false;
    },
    isAudition() {
      return this.task.taskType == 'audition' ? true : false;
    },
  },
  methods: {
    deleteImage() {
      let copy = _.cloneDeep(this.task);
      copy.thumbnail = null;
      this.$store.dispatch('taskbox/UPDATE_TASK', copy);
    },
    selectImage() {
      ipcRenderer.invoke('app:selectImage', { multiple: false }).then(async (path) => {
        if (path == undefined) return;

        let clip = await nativeImage.createThumbnailFromPath(path[0], { width: 512, height: 512 });
        let copy = _.cloneDeep(this.task);

        copy.thumbnail = clip.toDataURL();
        this.$store.dispatch('taskbox/UPDATE_TASK', copy);
      });
    },
    getClipBoardImage() {
      if (!clipboard.readImage().isEmpty()) {
        let clip = clipboard.readImage();
        let size = clip.getSize();
        let finalSize = 512;

        let copy = _.cloneDeep(this.task);

        copy.thumbnail = clip
          .resize({ width: finalSize * clip.getAspectRatio(), height: finalSize })
          .crop({ x: size.width / 2 - size.height / 2 - size.height / 2 / 2, y: 0, width: finalSize, height: finalSize })
          .toDataURL();

        this.$store.dispatch('taskbox/UPDATE_TASK', copy);
      }
    },
  },
};
</script>
