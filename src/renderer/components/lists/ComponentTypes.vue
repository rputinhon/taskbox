<template>
  <v-menu ref="addMenu" top rounded="pill" z-index="1" offset-y light nudge-left="8" nudge-bottom="65">
    <template v-slot:activator="{ on: menu, attrs }">
      <v-btn  fab left bottom absolute elevation="0" color="primary" v-bind="attrs" v-on="menu" x-small class="mb-9 ml-2 windowbar-button" :disabled="disabled">
        <svg width="28" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path d="m 22.065319,8.3519448 c -0.704083,0 -1.27124,0.5666409 -1.27124,1.2707236 V 21.058663 H 9.8872518 c -0.7040827,0 -1.2707237,0.567157 -1.2707237,1.27124 v 2.965194 c 0,0.704083 0.566641,1.271239 1.2707237,1.271239 H 20.794079 v 10.906829 c 0,0.704082 0.567157,1.270722 1.27124,1.270722 h 2.965194 c 0.704083,0 1.27124,-0.56664 1.27124,-1.270722 V 26.566336 h 11.435995 c 0.704083,0 1.270722,-0.567156 1.270722,-1.271239 v -2.965194 c 0,-0.704083 -0.566639,-1.27124 -1.270722,-1.27124 H 26.301753 V 9.6226684 c 0,-0.7040827 -0.567157,-1.2707236 -1.27124,-1.2707236 z" 
          :fill="disabled ? 'rgba(0,0,0,0.26)' : 'white'" stop-color="#000000" style="paint-order: fill markers stroke" />
        </svg>
      </v-btn>
    </template>
    <v-card color="background" max-width="47px" class="py-3 pb-13">
      <v-list-item class="px-0 ma-0" @click="addNode($event, { name: 'TaskBox' })">
        <v-list-item-content class="py-0">
          <svg class="categoryIcon" height="38" version="1.1" viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M 24,5.8925781 C 21.669477,6.5192873 19.431256,7.4955304 17.13811,8.2637827 13.599886,9.5352302 10.061662,10.806678 6.5234375,12.078125 5.3762767,12.774835 5.2269296,14.260409 4.6193636,15.388966 3.679185,17.597849 2.7390063,19.806732 1.7988277,22.015615 1.2307054,24.50009 3.9425225,24.0394 5.3131135,23.417573 c 0.480666,0.06902 0.089379,1.326253 0.216183,1.877482 0,3.074822 0,6.149644 0,9.224466 0.2167716,1.641443 2.0545414,1.655374 3.2557615,2.224815 4.902377,1.76165 9.804753,3.523301 14.70713,5.284951 1.340299,0.190342 2.547407,-0.667693 3.815762,-1.004143 4.799999,-1.740961 9.623297,-3.425071 14.408705,-5.201632 1.197697,-0.800906 0.614946,-2.385073 0.754048,-3.590802 0,-1.993587 0,-3.987173 0,-5.98076 1.071992,-0.56014 2.384344,-0.771912 3.236449,-1.659598 0.695242,-1.230119 -0.33702,-2.488794 -0.624785,-3.699319 -0.859506,-2.480301 -1.817587,-4.942367 -2.615564,-7.434048 -0.04835,-1.494187 -1.776155,-1.561978 -2.81934,-2.040536 C 34.600913,9.6057887 29.554362,7.7931288 24.507812,5.9804688 Z m 0,3.09375 C 28.177734,10.48763 32.355469,11.988932 36.533203,13.490234 32.355469,14.992187 28.177734,16.494141 24,17.996094 24,14.992839 24,11.989583 24,8.9863281 Z M 8.5292969,15.623047 c 4.6100261,1.656901 9.2200521,3.313802 13.8300781,4.970703 0.31132,1.301579 0.05922,2.685196 0.140625,4.020252 0,4.624759 0,9.249519 0,13.874279 -4.656901,-1.673828 -9.313802,-3.347656 -13.9707031,-5.021484 0,-5.947917 0,-11.895833 0,-17.84375 z M 39.470703,27.537109 c 0,1.976563 0,3.953125 0,5.929688 -4.656901,1.673828 -9.313802,3.347656 -13.970703,5.021484 0,-2.453776 0,-4.907552 0,-7.361328 0.161036,1.525095 1.909784,1.876814 3.019617,1.098773 3.650362,-1.562872 7.300724,-3.125745 10.951086,-4.688617 z"
              fill="grey"
            />
          </svg>
        </v-list-item-content>
      </v-list-item>
      <v-list-item class="px-0 mx-auto ma-0 py-0" @click="addNode($event, { name: 'Note' })">
        <v-list-item-content class="py-0">
          <svg class="categoryIcon" height="35" version="1.1" viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M 4.9887164,5.0166222 V 11.608239 H 43.011284 V 5.0166222 Z M 39.09047,6.9575401 A 1.3970416,1.3970416 0 0 1 40.487706,8.3547709 1.3970416,1.3970416 0 0 1 39.09047,9.7515198 1.3970416,1.3970416 0 0 1 37.693241,8.3547709 1.3970416,1.3970416 0 0 1 39.09047,6.9575401 Z M 4.9887164,12.539245 V 42.983378 H 37.780332 L 43.011284,38.2095 V 12.539245 Z M 26.678987,20.77588 h 2.176678 v 1.933701 h 2.244036 v 1.556488 h -2.244036 v 2.887802 c 0,0.316168 0.06295,0.531231 0.188606,0.644729 0.125657,0.10944 0.375257,0.164067 0.748172,0.164067 h 1.118652 v 1.556488 h -1.866824 c -0.859326,0 -1.469502,-0.178326 -1.830255,-0.535027 -0.356703,-0.360755 -0.535029,-0.970931 -0.535029,-1.830257 v -2.887802 h -1.082084 v -1.556488 h 1.082084 z M 13.50345,22.545513 c 0.786365,0 1.382092,0.240795 1.787435,0.723153 0.409396,0.482358 0.614416,1.183898 0.614416,2.104025 v 4.146464 h -2.189186 v -0.675039 -2.49856 c 0,-0.587746 -0.01397,-0.993383 -0.04234,-1.216322 -0.02432,-0.222938 -0.0689,-0.386817 -0.133757,-0.492206 -0.08512,-0.14187 -0.200497,-0.251604 -0.346421,-0.328618 -0.145922,-0.08107 -0.312484,-0.121248 -0.498942,-0.121248 -0.453983,0 -0.810635,0.176125 -1.070055,0.528773 -0.259419,0.348595 -0.388761,0.832869 -0.388761,1.453043 v 3.350177 H 9.0591627 V 22.709581 H 11.23584 v 0.996923 c 0.328328,-0.397236 0.676656,-0.688737 1.045517,-0.875194 0.368862,-0.190511 0.776219,-0.285797 1.222096,-0.285797 z m 7.661192,0 c 1.17144,0 2.085361,0.315993 2.742017,0.948326 0.660708,0.632335 0.991148,1.507798 0.991148,2.626544 0,1.118745 -0.33044,1.994209 -0.991148,2.626544 -0.656656,0.632332 -1.570577,0.948807 -2.742017,0.948807 -1.175494,0 -2.095538,-0.316475 -2.7603,-0.948807 -0.660708,-0.632335 -0.991149,-1.507799 -0.991149,-2.626544 0,-1.118746 0.330441,-1.994209 0.991149,-2.626544 0.664762,-0.632333 1.584806,-0.948326 2.7603,-0.948326 z m 14.531393,0 c 1.0701,0 1.925471,0.322115 2.565915,0.96661 0.644493,0.644495 0.966612,1.505992 0.966612,2.584202 v 0.62019 h -5.089017 c 0.05272,0.510732 0.237139,0.893597 0.553313,1.148962 0.316165,0.255365 0.758057,0.382988 1.325534,0.382988 0.458043,0 0.926145,-0.06687 1.404446,-0.200637 0.482366,-0.137815 0.976679,-0.344556 1.483358,-0.620188 v 1.678217 c -0.514784,0.194564 -1.02919,0.340555 -1.543975,0.437836 -0.514792,0.101336 -1.029675,0.152041 -1.54446,0.152041 -1.232243,0 -2.191226,-0.312071 -2.876259,-0.936298 -0.680976,-0.628282 -1.021457,-1.508148 -1.021457,-2.639053 0,-1.110639 0.33484,-1.9839 1.003655,-2.620288 0.672871,-0.636389 1.59684,-0.954582 2.772335,-0.954582 z m -0.01199,1.446788 c -0.42156,0 -0.764248,0.119778 -1.027721,0.35893 -0.263473,0.235099 -0.427349,0.575583 -0.492203,1.02146 h 2.82718 c 0,-0.413449 -0.121982,-0.74609 -0.365189,-0.997403 -0.23915,-0.255365 -0.552943,-0.382987 -0.942067,-0.382987 z M 21.164682,24.102 c -0.482357,0 -0.851256,0.173924 -1.106621,0.522518 -0.251313,0.344541 -0.377214,0.843263 -0.377214,1.495865 0,0.652602 0.125901,1.153041 0.377214,1.501637 0.255365,0.344542 0.624264,0.517226 1.106621,0.517226 0.474251,0 0.837027,-0.172684 1.088339,-0.517226 0.251313,-0.348596 0.376733,-0.849035 0.376733,-1.501637 0,-0.652602 -0.12542,-1.151324 -0.376733,-1.495865 C 22.001709,24.275924 21.638933,24.102 21.164682,24.102 Z"
              fill="grey"
            />
          </svg>
        </v-list-item-content>
      </v-list-item>
      <v-list-item class="px-0 mx-auto ma-0 py-0" @click="addNode($event, { name: 'File' })">
        <v-list-item-content class="py-0">
          <svg class="categoryIcon" height="33" version="1.1" viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg">
            <path
              d="m12.438 3.5879c-4.9029 0-8.8496 3.9467-8.8496 8.8496v23.125c0 4.9029 3.9467 8.8496 8.8496 8.8496h23.125c4.9029 0 8.8496-3.9467 8.8496-8.8496v-23.125l-8.8496-8.8496zm1.8184 13.635h2.3438v2.0098h-1.6934c-0.42757 0-0.7253 0.08061-0.89062 0.24023-0.16532 0.15392-0.24805 0.42484-0.24805 0.8125v0.66602h6.5508v9.5781h-3.0859v-7.3887h-3.4648v7.3887h-3.0859v-7.3887h-1.5059v-2.1895h1.5059v-0.66602c0-1.0433 0.2896-1.8126 0.87109-2.3086 0.58149-0.50168 1.4831-0.75391 2.7031-0.75391zm2.9766 0h3.0859v2.498h-3.0859zm6.0273 0h3.0625v13.307h-3.0625zm10.596 3.498c1.505 0 2.7086 0.45294 3.6094 1.3594 0.90644 0.90644 1.3594 2.1183 1.3594 3.6348v0.87109h-7.1582c0.07411 0.71831 0.33463 1.258 0.7793 1.6172 0.44467 0.35916 1.0652 0.53906 1.8633 0.53906 0.6442 0 1.3019-0.09507 1.9746-0.2832 0.6784-0.19383 1.3753-0.48343 2.0879-0.87109v2.3594c-0.72401 0.27364-1.4479 0.47841-2.1719 0.61523-0.72401 0.14252-1.4479 0.21484-2.1719 0.21484-1.7331 0-3.0815-0.43847-4.0449-1.3164-0.95775-0.88364-1.4375-2.1223-1.4375-3.7129 0-1.562 0.46951-2.7905 1.4102-3.6855 0.94634-0.89504 2.2471-1.3418 3.9004-1.3418zm-0.01758 2.0352c-0.59289 0-1.0748 0.16756-1.4453 0.50391-0.37056 0.33065-0.60019 0.8104-0.69141 1.4375h3.9766c0-0.58149-0.17162-1.0489-0.51367-1.4023-0.33635-0.35916-0.77889-0.53906-1.3262-0.53906z"
              fill="grey"
            />
          </svg>
        </v-list-item-content>
      </v-list-item>
      <v-list-item v-if="authenticated && active('Audition')" class="px-0 mx-auto ma-0 py-0" @click="addNode($event, { name: 'Audition' })">
        <v-list-item-content class="py-0">
          <svg class="categoryIcon" height="35" version="1.1" viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg">
            <path
              d="m 23.813533,3.1491618 c -11.39123,0 -20.6643712,9.2731412 -20.6643712,20.6643712 0,11.391232 9.2731412,20.662306 20.6643712,20.662306 11.391232,0 20.662306,-9.271074 20.662306,-20.662306 0,-11.39123 -9.271074,-20.6643712 -20.662306,-20.6643712 z m 0,3.5295004 c 9.483673,0 17.132804,7.6511958 17.132804,17.1348708 0,9.483678 -7.649131,17.132804 -17.132804,17.132804 -9.483675,0 -17.1348708,-7.649126 -17.1348708,-17.132804 0,-9.483675 7.6511958,-17.1348708 17.1348708,-17.1348708 z m 0.156063,4.4694948 c -4.187077,0 -7.615556,3.428472 -7.615556,7.615555 v 0.0021 c 0.002,1.565636 0.502398,3.044007 1.353406,4.28501 -3.278847,0.954866 -5.735567,3.869576 -5.735567,7.447607 v 2.230356 c 9e-5,0.900996 0.729919,1.631325 1.630908,1.631423 h 20.419425 c 0.900986,-9.8e-5 1.630812,-0.73043 1.630908,-1.631423 v -2.230356 c 0,-3.483152 -2.321904,-6.356773 -5.467882,-7.39283 0.87703,-1.252925 1.397881,-2.74861 1.399913,-4.339787 v -0.0021 c 0,-4.187081 -3.428468,-7.615553 -7.615555,-7.615555 z m 0,3.262333 v 5.29e-4 c 2.422956,0 4.351547,1.927987 4.352705,4.350639 -0.0019,1.736957 -1.025437,3.298254 -2.618961,3.98942 -1.618073,0.706362 -1.1175,3.121666 0.648023,3.126941 h 1.420584 c 2.586699,0 4.618323,2.033199 4.618323,4.62039 v 0.59893 H 15.234729 v -0.59893 c 0,-2.587191 2.031617,-4.62039 4.618322,-4.62039 h 1.735295 c 1.766701,-0.0027 2.269234,-2.420106 0.65009,-3.126941 -1.592871,-0.690892 -2.618494,-2.251252 -2.621546,-3.987353 v -0.0026 c 9e-4,-2.422656 1.929759,-4.350639 4.352706,-4.350639 z"
              fill="grey"
            />
          </svg>
        </v-list-item-content>
      </v-list-item>
      <!-- <v-list class="my-1 mt-0 pt-0" v-for="(category, c) in getcategoryActive()" :key="c" color="background">
          <v-menu nudge-top="30" offset-x open-on-hover light v-if="c>0">
            <template v-slot:activator="{ on: menu, attrs }">
              <v-badge dot overlap :value="''" color="success" offset-x="6" offset-y="35">
                <v-btn v-on="menu" v-bind="attrs" icon height="32">
                  <svg class="categoryIcon" width="32" height="45" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <g v-html="category.svgIcon"></g>
                  </svg>
                </v-btn>
              </v-badge>
            </template>
            <v-card color="background">
              <v-list-item-group v-for="item in getcategoryItems(category.name)" :key="item.name">
                <v-list-item v-if="item.name !== 'TaskBox'" class="py-0" @click="addNode($event, item), closeMenu()">
                  <v-list-item-content>
                    <v-list-item-title v-text="item.name"></v-list-item-title>
                  </v-list-item-content>
                  <v-list-item-icon>
                    <v-img draggable="true" @dragstart="startDrag($event, item), (grabbing = true)" @dragend="grabbing = false" :class="grabbing && 'grabbing'">
                      <svg class="categoryIcon pt-1" width="40" height="40" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path :d="item.meta.typeicon" :fill="item.meta.color" />
                      </svg>
                    </v-img>
                  </v-list-item-icon>
                </v-list-item>
              </v-list-item-group>
            </v-card>
          </v-menu>
        </v-list> -->
    </v-card>
  </v-menu>
</template>

<script>
import { mapState } from 'vuex';
import { NodeView } from '../../libs/nodeview';
export default {
  name: 'ComponentType',
  props: { disabled: Boolean },
  data: () => ({ grabbing: false }),
  computed: {
    ...mapState({
      myTemplates: (state) => state.templates.myTemplates,
      library: (state) => state.library.library,
    }),
    authenticated() {
      return this.$store.getters['user/authenticated'];
    },
  },
  methods: {
    active(name) {
      return this.library.blockLibrary.blocktypes.filter((b) => b.name === name).active || false;
    },
    getcategoryActive() {
      if (!this.library) return;
      return this.library.categoryLibrary.filter((c) => c.active === true && this.getcategoryItems(c.name).length > 0);
    },
    getcategoryItems(category) {
      return this.library.blockLibrary.blocktypes.filter((b) => b.meta.category === category && b.properties.isactive);
    },
    addNode(evt, item) {
      NodeView.createNodeAndAdd(item.name, evt);
    },
    addTemplate(evt, template) {
      NodeView.addTemplate(template, evt);
    },
    startDrag(evt, item) {
      evt.dataTransfer.dropEffect = 'move';
      evt.dataTransfer.effectAllowed = 'move';
      evt.dataTransfer.setData('item', item.name);
      evt.dataTransfer.setDragImage(evt.target, 0, 0);
    },
    closeMenu() {
      this.$refs.addMenu.isActive = false;
    },
    getTemplates() {
      this.$store.dispatch('templates/FETCH_ALL');
    },
  },
};
</script>

<style>
.grabbing {
  cursor: grabbing;
}
</style>
