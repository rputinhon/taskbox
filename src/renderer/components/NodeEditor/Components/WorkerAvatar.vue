<template>
  <v-menu rounded="0" bottom light offset-y v-if="authenticated">
    <template v-slot:activator="{ on: menu }">
      <v-row align="center" :justify="justify" style="direction:rtl;min-width: 70px; max-width: fit-content !important" :style="ExtraStyle">
        <v-list v-if="task.workers.length > 0" :class="ExtraClass && ExtraClass" class="text-right mx-1 mr-4" :style="`position:absolute;background-color:transparent;`">
          <v-avatar style="cursor: pointer;margin-left:-10px" color="white" v-on="{ ...menu }" v-for="(worker, m) in task.workers" :size="size" :key="m" >
            <v-tooltip bottom right transition="none" v-if="m < max">
              <template v-slot:activator="{ on: tooltip }">
                <member-item :id="worker.profile" :size="size - 2" :options="['onlyAvatar']" v-on="{ ...tooltip }" />
              </template>
            </v-tooltip>
            <a v-else class="mx-1">+{{ workersCount - max }}</a>
          </v-avatar>
        </v-list>
        <v-list v-else :class="ExtraClass && ExtraClass" class="text-right mx-1 mr-3" :style="`position:absolute;background-color:transparent;`">
          <v-avatar style="cursor: pointer" v-on="{ ...menu }" :size="size" color="white">
            <svg version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="m 20.353212,30.787077 q 0,-1.935949 0.517754,-3.4667 0.517753,-1.53075 1.260618,-2.61128 0.742864,-1.080529 1.95846,-2.521236 0.967974,-1.125551 1.508239,-1.890926 0.540265,-0.787887 0.900441,-1.710839 0.382688,-0.945464 0.382688,-2.048504 v -0.02251 q 0,-1.530751 -0.765375,-2.363659 Q 25.373173,13.296003 24,13.296003 q -1.350663,0 -2.116038,0.945463 -0.742864,0.922952 -0.765375,2.61128 v 0.02251 h -6.393134 v -0.02251 q 0.112555,-2.971457 1.238107,-5.064983 1.125552,-2.1160371 3.151545,-3.2190778 2.048504,-1.1030408 4.862384,-1.1030408 2.926434,0 5.01996,0.9904856 2.093527,0.9904855 3.174056,2.881413 1.103041,1.868415 1.103041,4.524718 v 0.02251 q 0,1.733349 -0.495243,3.129034 -0.472731,1.395684 -1.193085,2.453702 -0.697842,1.035508 -1.868416,2.408681 -1.10304,1.328151 -1.733349,2.228593 -0.607798,0.900441 -1.035508,2.093526 -0.42771,1.170574 -0.42771,2.588769 z m 0.02251,3.579255 h 6.168024 v 6.168023 h -6.168024 z" fill="#0187f3" />
            </svg>
          </v-avatar>
        </v-list>
      </v-row>
    </template>
    <v-card class="mx-auto" max-width="400">
      <v-list-item-group>
        <v-list-item link @click="changeWorker()">
          <v-list-item-icon class="my-auto mx-2">
            <svg width="28" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path
                d="m 15.799846,15.472064 c -4.691982,0 -8.5338938,3.841912 -8.5338938,8.533895 v 0.0024 c 0.00219,1.754435 0.5627167,3.410711 1.5163438,4.801357 -3.6742287,1.070006 -6.4272008,4.336342 -6.4272008,8.345839 v 2.499468 c 1.012e-4,1.009635 0.8185463,1.82808 1.8281816,1.828182 H 27.064112 c 1.009635,-1.02e-4 1.82808,-0.818547 1.828181,-1.828182 v -2.499468 c 0,-3.903169 -2.601925,-7.122957 -6.127265,-8.283948 0.982787,-1.404003 1.566434,-3.080197 1.568713,-4.863248 v -0.0024 c 0,-4.691983 -3.841912,-8.533895 -8.533895,-8.533895 z m 0,3.656364 c 2.715126,0 4.876234,2.160358 4.877532,4.87515 -0.0024,1.946412 -1.149412,3.695969 -2.935089,4.470476 -1.813196,0.791537 -1.252392,3.498107 0.726036,3.504015 h 1.592518 c 2.898623,0 5.175087,2.278293 5.175087,5.177466 v 0.671286 H 6.0114583 v -0.671286 c 0,-2.899173 2.276462,-5.177466 5.1750867,-5.177466 h 1.944823 c 1.979735,-0.0033 2.5428,-2.711944 0.728416,-3.504015 -1.784948,-0.774191 -2.93405,-2.522646 -2.937469,-4.468095 v -0.0024 c 0.0013,-2.714792 2.162408,-4.875151 4.877531,-4.875151 z M 32.552465,6.5167582 c -4.691983,0 -8.533894,3.8419118 -8.533894,8.5338938 v 0.0024 c 0.0022,1.754435 0.562715,3.41071 1.516342,4.801357 -0.350673,0.102122 -0.688913,0.230476 -1.02121,0.371349 0.356126,1.002958 0.552263,2.078543 0.552263,3.199317 v 0.0024 c -1.89e-4,0.15345 -0.01133,0.305013 -0.01905,0.457045 0.821177,-0.545753 1.813396,-0.86172 2.89224,-0.86172 h 1.944823 c 1.979736,-0.0033 2.5428,-2.711944 0.728416,-3.504015 -1.784947,-0.774191 -2.93405,-2.522643 -2.937468,-4.468095 v -0.0024 c 0.0013,-2.714792 2.162407,-4.875151 4.877531,-4.875151 2.715125,0 4.876233,2.160359 4.877531,4.875151 -0.0024,1.946412 -1.149412,3.695969 -2.935088,4.470476 -1.813197,0.791537 -1.252392,3.498107 0.726035,3.504014 h 1.592518 c 2.898624,0 5.175086,2.278295 5.175086,5.177468 V 28.87157 H 24.704133 c 1.798049,0.972797 2.691769,1.930582 3.984864,3.656363 h 15.127726 c 1.009635,-1.01e-4 1.82808,-0.818546 1.828181,-1.828181 v -2.499467 c 0,-3.903169 -2.601925,-7.122957 -6.127264,-8.283948 0.982787,-1.404003 1.566434,-3.080197 1.568713,-4.863248 v -0.0024 c 0,-4.691982 -3.841911,-8.5338938 -8.533894,-8.5338938 z"
                fill="#353535"
              />
            </svg>
          </v-list-item-icon>
          <v-list-item-title class="text-center" v-text="'Set Workers'"></v-list-item-title>
        </v-list-item>
        <v-list-item link @click="setOpen()">
          <v-list-item-icon class="my-auto mx-1">
            <svg width="28" version="1.1" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path
                d="m 36.555909,6.1598943 c -0.923124,0 -1.771677,0.3781629 -2.388484,0.9803019 -0.0205,0.014811 -0.06006,0.037025 -0.07648,0.050126 -6.604547,5.2693008 -8.57756,6.7716148 -10.262422,7.3008468 -0.84243,0.264616 -1.537377,0.28659 -2.797245,0.191202 -1.259868,-0.09539 -2.995715,-0.324954 -5.480286,-0.447001 -1.462287,-0.07183 -2.714418,0.709783 -3.407027,1.851567 h -0.419613 c -2.2034145,0 -4.0390297,1.837165 -4.0390297,4.04058 v 3.466972 c 0,2.203414 1.8356152,4.03903 4.0390297,4.03903 h 0.257349 c 0.416655,0.854318 1.123387,1.557226 2.021065,1.902208 0.01073,0.142484 0.03247,0.285994 0.0677,0.429948 l 2.117184,8.650118 c 0.143222,0.585264 0.385095,1.208969 0.908471,1.791105 0.523375,0.582139 1.435966,1.058852 2.359029,1.058852 h 1.531173 c 0.923064,0 1.710815,-0.323175 2.36368,-0.928108 0.652865,-0.604944 1.183541,-1.731748 0.904338,-2.872695 L 22.27255,29.567768 c 2.436474,0.205933 4.26679,0.75986 5.756754,1.53479 2.600974,1.352809 3.457494,2.997478 5.548499,5.798611 0.577619,1.031851 1.707157,1.748216 2.978113,1.748216 1.84023,0 3.383774,-1.50136 3.383772,-3.288689 V 9.5235131 9.4485831 c 0,-1.6069275 -1.248847,-2.9787836 -2.838069,-3.2401122 -0.173289,-0.032533 -0.354592,-0.053201 -0.545703,-0.048576 z m -5.16e-4,1.978174 c 0.747633,0 1.349269,0.584886 1.349271,1.3110308 V 35.360696 c 0,0.726144 -0.601638,1.311031 -1.349271,1.311031 -0.747639,0 -1.349791,-0.584887 -1.349791,-1.311031 V 9.4490991 c 0,-0.326845 0.126331,-0.6214661 0.328663,-0.8505939 0.198353,-0.1940309 0.485561,-0.3788643 0.914157,-0.4501018 0.03589,-0.00276 0.07033,-0.010335 0.106971,-0.010335 z M 33.170586,10.66763 V 33.008383 C 29.757694,28.897716 25.701186,26.6161 15.452287,27.757026 14.413444,27.87267 13.565581,26.91558 13.565581,25.870319 v -7.750948 c 0,-1.045261 0.842705,-1.93799 1.886706,-1.886707 9.078319,0.445946 6.923084,2.978761 17.718299,-5.565034 z m -21.6023,7.425903 c -6.1e-5,0.0089 -0.0015,0.01749 -0.0015,0.02635 v 7.508068 C 10.510915,25.547941 9.6841639,24.671437 9.6841639,23.594489 V 20.127 c 0,-1.077486 0.8275461,-1.954251 1.8841221,-2.033467 z M 19.818945,29.4794 c 0.127768,-0.0011 0.248117,0.0021 0.373104,0.0026 7.39e-4,0.003 0.0019,0.0058 0.0026,0.0088 l 2.116667,8.649602 c 0.174591,0.713455 -0.590994,1.326018 -1.325501,1.326018 H 19.45566 c -0.734507,0 -1.150909,-0.612563 -1.3255,-1.326018 l -2.063957,-8.434628 c 1.3704,-0.141727 2.620036,-0.216797 3.752742,-0.226343 z"
                fill="#353535"
              />
            </svg>
          </v-list-item-icon>
          <v-list-item-title class="text-center" v-text="'Set Open Task'"></v-list-item-title>
        </v-list-item>
      </v-list-item-group>
    </v-card>
  </v-menu>
</template>

<script>
import store from '../../../store';
import MemberItem from '../../lists/MemberItem.vue';
import { postType } from '../../../store/models/PostModel';

export default {
  components: { MemberItem },
  name: 'WorkerAvatar',
  props: { task: Object, options: Array, size: Number, max: Number, justify: String, ExtraClass: String, ExtraStyle: String },
  data() {
    return {
      selectedWorker: 0,
    };
  },
  created() {
    // eventBus.$on('updateWorkers', async () => {
    //   if(!this.node)return;
    //   NodeView.updateNode(this.node.id);
    // });
  },
  computed: {
    authenticated() {
      return store.getters['user/authenticated'];
    },
    workersCount() {
      return this.task.workers.length;
    },
    members() {
      return store.state.user.members;
    },
    color() {
      return store.state.user.session.authenticated.color || 'grey';
    },
  },
  methods: {
    member(id) {
      return this.members.find((m) => m.id == id);
    },
    isAdmin(id) {
      return id == store.state.user.profile.id ? true : false;
    },
    setOpen() {
      this.$store.commit('post/OPEN_POST_CREATOR', { postType: postType.TASK.value, data: { task: this.task.id } });
    },
    changeWorker() {
      store.commit('taskbox/CHANGE_TASK_WORKER', this.entity);
    },
  },
};
</script>
